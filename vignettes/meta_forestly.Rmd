---
title: "Closer look at `meta_forestly()`"
output:
  rmarkdown::html_document:
    self_contained: no
    number_sections: yes
    code_folding: hide
vignette: |
  %\VignetteIndexEntry{Controlling Layout}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  eval = TRUE,
  echo = TRUE
)
```

```{r}
library(forestly)
library(metalite)
```

# Overview

`meta_forestly()` is the first step in the Interactive Forest Plot generation workflow and is a wrapper of several functions from [metalite](https://merck.github.io/metalite/). In essence, it defines a metadata including adam datesets, population, observations and parameters to be used for a forest plot. Since the requirement for the parameters of interest might differ from deliverable to deliverable, `parameter_term` argument in `meta_forestly` includes several options as outlined in this [vignette](https://merck.github.io/forestly/articles/forestly.html#define-metadata)

# `parameter_term` examples

Prior to turning to the examples, just a reminder that the treatment group variable in the ADaM datasets should be set as a factor, otherwise a warning will be generated. 
For example if this is your for you have in the `TRT01A` variable:
```{r}
unique(forestly_adsl$TRT01A)
```

You can easily turn it into a factor variable with the desired labels using the following code: 

```{r}
forestly_adsl$TRTA <- factor(
  forestly_adsl$TRT01A, 
  levels = c("Xanomeline Low Dose", "Placebo"), 
  labels = c("Low Dose", "Placebo")
  )
```

A similar approach need to be applied to the ADAE as well:

```{r}
forestly_adae$TRTA <- factor(
  forestly_adae$TRTA, 
  levels = c("Xanomeline Low Dose", "Placebo"), 
  labels = c("Low Dose", "Placebo")
  )
```

If the deliverable requires a forest plot of all adverse events and serious adverse events, the following code could be used:

```{r}
meta_forestly(
  dataset_adsl = forestly_adsl,
  dataset_adae = forestly_adae,
  population_term = "apat",
  population_subset = SAFFL == "Y",
  observation_term = "all",
  observation_subset = SAFFL == "Y",
  parameter_term = "any;ser"
) |>
  prepare_ae_forestly() |>
  format_ae_forestly() |>
  ae_forestly()
```

If, however, grade 3-5 adverse events need to be plotted as well, then this could be done using: 

```{r}
meta_forestly(
  dataset_adsl = forestly_adsl,
  dataset_adae = forestly_adae,
  population_term = "apat",
  population_subset = SAFFL == "Y",
  observation_term = "all",
  observation_subset = SAFFL == "Y",
  parameter_term = "any;ser;g35"
) |>
  prepare_ae_forestly() |>
  format_ae_forestly() |>
  ae_forestly()
```

# Adding a new parameter

Below we demonstrate how to add a new parameter to the `meta_forestly()`. Consider, for instance, that now we need to plot adverse events which resulted in dose reductions, a parameter that is currently not available in the predefined options of the `parameter_term`.

```{r}
meta_new <- meta_adam(
  population = forestly_adsl,
  observation = forestly_adae
  ) |>
  define_plan(plan = metalite::plan(
    analysis = "ae_forestly",
    population = "apat",
    observation = "all",
    parameter = "any;ser;g35;reduc"
    )
  ) |>
  define_population(
    name = "apat",
    group = "TRTA",
  ) |>
  define_observation(
    name = "all",
    group = "TRTA",
    label = "All AEs"
  ) |>
  define_parameter(
    name = "reduc",
    subset = AEACN == "DOSE REDUCED",
    label = "adverse events resulting in dose reduction",
    var = "AEDECOD",
    soc = "AEBODSYS",
    seq = 900,
    term1 = "",
    term2 = "Result in Dose Reduction",
    summ_row = "dose reduction"
  ) |>
  define_analysis(
    name = "ae_forestly",
    label = "Interactive forest plot"
  ) |>
  meta_build()

meta_new |>
  prepare_ae_forestly(parameter = "any;ser;g35;reduc") |>
  format_ae_forestly() |>
  ae_forestly()
```


